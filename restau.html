<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <!-- Compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />
    <link rel="stylesheet" href="styles/main.css" type="text/css" />

    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.3/firebase-firestore.js"></script>
    <title>Aldo's Review</title>
  </head>
  <body class="grey ligthen=3">
    <!-- NAVBAR -->
    <nav class="z-depth-0 grey lighten-4">
      <div class="nav-wrapper container">
        <a href="#" class="brand-logo">
          <img
            onclick="window.location.href ='/index.html'"
            src="img/logo.svg"
            style="width: 180px; margin-top: 10px;"
          />
        </a>
      </div>
    </nav>
    <div class="restaurant-details container">
      <div class="row">
        <div id="image" class="col-md-6 restaurant-photo"></div>
        <div class="col-md-6 restaurant-info">
          <h2 id="name"></h2>
          <p><span id="price"></span></p>
          <p><span id="address"></span></p>
          <p><span id="category"></span></p>
          <p><span id="city"></span></p>
          <br />
          <h3>About This Place</h3>
          <p><span id="description"></span></p>
          <div id="map"></div>
          <button id="get">Get Direction</button>
          <script
            async
            defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPC-rsgBO157fHqHlzA3xCm0d8htx6lEY&callback=initMap"
          ></script>
        </div>
      </div>
      <a class="back-button" onclick="window.location.href ='/index.html'"
        >Back to home page</a
      >
    </div>
    <br /><br />
    <div class="restaurant-review" style="text-align: center;">
      <h3>Review</h3>

      <!-- <input type="textarea" placeholder="Enter review"><br> -->
      <textarea
        id="review"
        rows="6"
        cols="20"
        placeholder="Enter Review"
        style="width: 50%; height: 20%; background-color: aliceblue;"
      ></textarea
      ><br />
      <input
        type="button"
        value="Add Review"
        id="submitReview"
        style="display: block; margin: auto;"
      />
      <br /><br />
      <div id="restauReview" style="margin-bottom: 50px;"></div>
    </div>

    <!-- <h1>Restaurant Info</h1>
<div>
    <p >Name: <span id="name"></span></p>
    <p>City: <span id="city"></span></p>
    <p>Category: <span id="category"></span></p>
    <p>Price: <span id="price"></span></p>
    <p>Address: <span id="address"></span></p>
    <p>Image: <span id="image"></span></p>

    <button onclick="window.location.href ='/index.html'">Home</button>
</div> -->

    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyBMRTfK_7w3PZ3LfZCdWaqoEaA_CqZM5r4",
        authDomain: "form-50005.firebaseapp.com",
        databaseURL: "https://form-50005.firebaseio.com",
        projectId: "form-50005",
        storageBucket: "form-50005.appspot.com",
        messagingSenderId: "790644686206",
        appId: "1:790644686206:web:f0e8c087bd3ab7e95dc72f",
        measurementId: "G-CR41MFE7Q1",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      //Make auth and firestore reference
      const auth = firebase.auth();
      const db = firebase.firestore();

      //let restau = JSON.parse(sessionStorage.getItem('value'));
      let restau;
      const id = sessionStorage.getItem("id");
      const userID = sessionStorage.getItem("userID");
      console.log(id);

      //   db.collection("restaurants").doc(id)
      // .onSnapshot(function(doc) {
      //     console.log("Current data: ", doc.data());
      //     console.log("new message: ", doc.data().reviews )
      // });

      db.collection("restaurants")
        .doc(id)
        .onSnapshot((snap) => {
          if (snap.exists) {
            restau = snap.data();
            console.log("Document data:", restau);

            let name = document.querySelector("#name");
            name.innerHTML = restau.name;
            let city = document.querySelector("#city");
            city.innerHTML = restau.city;
            let address = document.querySelector("#address");
            address.innerHTML = restau.address;
            let cat = document.querySelector("#category");
            cat.innerHTML = restau.category;
            let price = document.querySelector("#price");
            price.innerHTML = restau.price;
            let description = document.querySelector("#description");
            description.innerHTML = restau.description;
            let image = document.querySelector("#image");
            image.innerHTML = '<img src="' + restau.image + '" />';
            let reviewList = document.querySelector("#restauReview");

            var unique = Array.from(new Set(restau.reviews));
            //console.log(unique)
            // restau.reviews.map(rev =>{
            //     $('#restauReview p').remove()
            //     $('#restauReview').append("<p>" +rev.note+"</p><p><b>Reviewed By: </b>"+rev.user+"</p>")

            // })
            let val;

            restau.reviews.forEach(function (rev) {
              console.log(rev.note);
              val =
                "<p>" +
                rev.note +
                "</p><p><b>Reviewed By: </b>" +
                rev.user +
                "</p>";
            });
            $("#restauReview").append(val);
          } else {
            // doc.data() will be undefined in this case
            console.log("No such document!");
          }
        });

      // db.collection("restaurants").doc(id)
      // .get()
      // .then(doc =>{
      //   if (doc.exists) {
      //   restau = doc.data()
      //   console.log("Document data:", restau.name);

      // let name = document.querySelector("#name");
      // name.innerHTML = restau.name;
      // let city = document.querySelector("#city");
      // city.innerHTML = restau.city;
      // let address = document.querySelector("#address");
      // address.innerHTML = restau.address;
      // let cat = document.querySelector("#category");
      // cat.innerHTML = restau.category;
      // let price = document.querySelector("#price");
      // price.innerHTML = restau.price;
      // let description = document.querySelector("#description");
      // description.innerHTML = restau.description;
      // let image = document.querySelector("#image");
      // image.innerHTML = '<img src="' + restau.image + '" />';
      // let reviewList = document.querySelector("#restauReview");

      //   console.log(restau.name)
      //  restau.reviews.forEach(function(rev) {
      //      if(rev){
      //         console.log(rev.note)
      //         $('#restauReview').append("<p>" +rev.note+"</p><p><b>Reviewed By: </b>"+rev.user+"</p>")

      //      }

      //  })

      // } else {
      //     // doc.data() will be undefined in this case
      //     console.log("No such document!");
      // }

      //   })

      //Review Form
      const reviewForm = document.querySelector("#submitReview");
      const review = document.querySelector("#review");
      `import firebase from "firebase/firebase";`;

      reviewForm.addEventListener("click", function (e) {
        const msg = review.value;
        console.log(msg);
        if (msg == "") {
          alert("Enter a review");
          return;
        }
        db.collection("restaurants")
          .doc(id)
          .update({
            reviews: firebase.firestore.FieldValue.arrayUnion({
              user: userID,
              note: msg,
            }),
          });
        review.value = "";
        e.preventDefault();
      });

      //$("#submitReview").click(() => location.reload())
    </script>

    <script src="scripts/auth.js"></script>
    <script src="scripts/index.js"></script>
  </body>
</html>
